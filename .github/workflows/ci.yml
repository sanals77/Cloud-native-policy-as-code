name: CI - Build and Test with Policy Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 537651148488
  ECR_API_REPOSITORY: cloud-native-app-dev-api-service
  ECR_WORKER_REPOSITORY: cloud-native-app-dev-worker-service

jobs:
  # Linting and Unit Tests
  lint-and-test:
    name: Lint and Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies for API service
        run: |
          cd microservices/api-service
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Lint API service
        run: |
          cd microservices/api-service
          flake8 app.py --max-line-length=120 --ignore=E402

      - name: Run API service tests
        run: |
          cd microservices/api-service
          pytest test_app.py -v --cov=app --cov-report=xml

      - name: Install dependencies for Worker service
        run: |
          cd microservices/worker-service
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Lint Worker service
        run: |
          cd microservices/worker-service
          flake8 worker.py --max-line-length=120

      - name: Run Worker service tests
        run: |
          cd microservices/worker-service
          pytest test_worker.py -v --cov=worker --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./microservices/api-service/coverage.xml,./microservices/worker-service/coverage.xml

  # Build Docker images
  build-images:
    name: Build and Scan Docker Images
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API service image
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/api-service
          file: ./microservices/api-service/Dockerfile
          tags: ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }}
          outputs: type=docker,dest=/tmp/api-image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Worker service image
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/worker-service
          file: ./microservices/worker-service/Dockerfile
          tags: ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }}
          outputs: type=docker,dest=/tmp/worker-image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Load images
        run: |
          docker load --input /tmp/api-image.tar
          docker load --input /tmp/worker-image.tar

      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Scan API image with Trivy
        run: |
          trivy image --severity HIGH,CRITICAL --format json --output api-scan-results.json ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }}
          trivy image --severity HIGH,CRITICAL ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }}

      - name: Scan Worker image with Trivy
        run: |
          trivy image --severity HIGH,CRITICAL --format json --output worker-scan-results.json ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }}
          trivy image --severity HIGH,CRITICAL ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }}

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: |
            api-scan-results.json
            worker-scan-results.json

      - name: Check for vulnerabilities
        id: vuln-check
        run: |
          # Parse vulnerability counts
          API_CRITICAL=$(cat api-scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' 2>/dev/null || echo "0")
          API_HIGH=$(cat api-scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' 2>/dev/null || echo "0")
          WORKER_CRITICAL=$(cat worker-scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' 2>/dev/null || echo "0")
          WORKER_HIGH=$(cat worker-scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' 2>/dev/null || echo "0")
          
          echo "api_critical=$API_CRITICAL" >> $GITHUB_OUTPUT
          echo "api_high=$API_HIGH" >> $GITHUB_OUTPUT
          echo "worker_critical=$WORKER_CRITICAL" >> $GITHUB_OUTPUT
          echo "worker_high=$WORKER_HIGH" >> $GITHUB_OUTPUT
          
          echo "## ðŸ”’ Container Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | CRITICAL | HIGH | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$API_CRITICAL" -gt 0 ]; then
            echo "| API Service | $API_CRITICAL | $API_HIGH | âŒ **Blocked** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API Service | $API_CRITICAL | $API_HIGH | âœ… **Passed** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$WORKER_CRITICAL" -gt 0 ]; then
            echo "| Worker Service | $WORKER_CRITICAL | $WORKER_HIGH | âŒ **Blocked** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Worker Service | $WORKER_CRITICAL | $WORKER_HIGH | âœ… **Passed** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show top vulnerabilities
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Top Vulnerabilities Detected" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat api-scan-results.json | jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH") | "[\(.Severity)] \(.VulnerabilityID): \(.PkgName) - \(.Title)"' 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Fail if critical vulnerabilities found
          if [ "$API_CRITICAL" -gt 0 ] || [ "$WORKER_CRITICAL" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found! Blocking deployment."
            exit 1
          fi

      - name: Upload images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: |
            /tmp/api-image.tar
            /tmp/worker-image.tar

  # Validate Terraform with OPA
  validate-terraform:
    name: Validate Terraform with Policy-as-Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Terraform Init
        run: |
          cd infrastructure/terraform
          terraform init -backend=false -upgrade

      - name: Terraform Validate
        run: |
          cd infrastructure/terraform
          terraform validate

      - name: Terraform Plan
        run: |
          cd infrastructure/terraform
          terraform plan -out=tfplan.binary || echo "Plan may fail without AWS credentials - continuing"
        continue-on-error: true

      - name: Generate Terraform JSON (if plan succeeded)
        run: |
          cd infrastructure/terraform
          if [ -f tfplan.binary ]; then
            terraform show -json tfplan.binary > tfplan.json
          else
            echo '{"planned_values":{},"resource_changes":[]}' > tfplan.json
          fi
        continue-on-error: true

      - name: Validate Terraform Plan with OPA - Security
        id: opa-security
        run: |
          cd infrastructure/terraform
          if [ -f tfplan.json ] && [ -s tfplan.json ]; then
            RESULT=$(opa eval --data ../../policies/terraform/security.rego --input tfplan.json --format pretty "data.terraform.security.deny" 2>&1 || true)
            echo "$RESULT"
            
            # Store result for summary
            echo "SECURITY_RESULT<<EOF" >> $GITHUB_ENV
            echo "$RESULT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            if echo "$RESULT" | grep -qi "violation"; then
              echo "security_violations=true" >> $GITHUB_OUTPUT
            else
              echo "security_violations=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Terraform plan not available, skipping OPA validation"
            echo "security_violations=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Validate Terraform Plan with OPA - Cost
        id: opa-cost
        run: |
          cd infrastructure/terraform
          if [ -f tfplan.json ] && [ -s tfplan.json ]; then
            RESULT=$(opa eval --data ../../policies/terraform/cost.rego --input tfplan.json --format pretty "data.terraform.cost.warn" 2>&1 || true)
            echo "$RESULT"
            
            echo "COST_RESULT<<EOF" >> $GITHUB_ENV
            echo "$RESULT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "Terraform plan not available, skipping OPA validation"
          fi
        continue-on-error: true

      - name: "ðŸ“Š Generate Terraform Policy Summary"
        run: |
          echo "## ðŸ—ï¸ Terraform Policy Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.opa-security.outputs.security_violations }}" == "true" ]; then
            echo "### âŒ Security Policy Violations Detected" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ env.SECURITY_RESULT }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Security Policies: All checks passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cost Policy Warnings" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.COST_RESULT }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Terraform plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infrastructure/terraform/tfplan.json

  # Validate Kubernetes manifests with OPA
  validate-kubernetes:
    name: Validate Kubernetes Manifests with Policy-as-Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Render Helm templates - API Service
        run: |
          helm template api-service ./infrastructure/kubernetes/helm/api-service > api-manifests.yaml

      - name: Render Helm templates - Worker Service
        run: |
          helm template worker-service ./infrastructure/kubernetes/helm/worker-service > worker-manifests.yaml

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate API manifests with OPA
        id: validate-api
        run: |
          echo "=== Validating API Service Manifests ==="
          
          VIOLATIONS=""
          VIOLATION_COUNT=0
          
          # Extract and validate each Deployment
          yq eval 'select(.kind == "Deployment")' api-manifests.yaml > /tmp/api-deployment.yaml 2>/dev/null || true
          
          if [ -s /tmp/api-deployment.yaml ]; then
            RESULT=$(opa eval --data policies/kubernetes/security.rego --input /tmp/api-deployment.yaml --format pretty "data.kubernetes.security.deny" 2>&1 || true)
            echo "$RESULT"
            
            if echo "$RESULT" | grep -q "must"; then
              VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              VIOLATIONS="$VIOLATIONS\n$RESULT"
            fi
          fi
          
          echo "api_violations=$VIOLATION_COUNT" >> $GITHUB_OUTPUT
          echo "API_VIOLATIONS<<EOF" >> $GITHUB_ENV
          echo -e "$VIOLATIONS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Validate Worker manifests with OPA
        id: validate-worker
        run: |
          echo "=== Validating Worker Service Manifests ==="
          
          VIOLATIONS=""
          VIOLATION_COUNT=0
          
          yq eval 'select(.kind == "Deployment")' worker-manifests.yaml > /tmp/worker-deployment.yaml 2>/dev/null || true
          
          if [ -s /tmp/worker-deployment.yaml ]; then
            RESULT=$(opa eval --data policies/kubernetes/security.rego --input /tmp/worker-deployment.yaml --format pretty "data.kubernetes.security.deny" 2>&1 || true)
            echo "$RESULT"
            
            if echo "$RESULT" | grep -q "must"; then
              VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              VIOLATIONS="$VIOLATIONS\n$RESULT"
            fi
          fi
          
          echo "worker_violations=$VIOLATION_COUNT" >> $GITHUB_OUTPUT
          echo "WORKER_VIOLATIONS<<EOF" >> $GITHUB_ENV
          echo -e "$VIOLATIONS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: "ðŸ“Š Generate Kubernetes Policy Summary"
        run: |
          echo "## ðŸ” Kubernetes Policy Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Policy Violations | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          API_VIOLATIONS="${{ steps.validate-api.outputs.api_violations }}"
          WORKER_VIOLATIONS="${{ steps.validate-worker.outputs.worker_violations }}"
          
          if [ "$API_VIOLATIONS" -gt 0 ]; then
            echo "| API Service | $API_VIOLATIONS | âŒ **Violations Found** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API Service | 0 | âœ… **Compliant** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$WORKER_VIOLATIONS" -gt 0 ]; then
            echo "| Worker Service | $WORKER_VIOLATIONS | âŒ **Violations Found** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Worker Service | 0 | âœ… **Compliant** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$API_VIOLATIONS" -gt 0 ] || [ "$WORKER_VIOLATIONS" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Policy Violations Details" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ env.API_VIOLATIONS }}" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.WORKER_VIOLATIONS }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # Generate SBOM
  generate-sbom:
    name: Generate Software Bill of Materials
    runs-on: ubuntu-latest
    needs: build-images
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp

      - name: Load images
        run: |
          docker load --input /tmp/api-image.tar
          docker load --input /tmp/worker-image.tar

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM for API service
        run: |
          syft ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }} -o cyclonedx-json > api-sbom.json

      - name: Generate SBOM for Worker service
        run: |
          syft ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }} -o cyclonedx-json > worker-sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            api-sbom.json
            worker-sbom.json
