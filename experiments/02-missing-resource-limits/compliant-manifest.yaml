---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: worker-service-secure
  labels:
    app: worker
    version: "1.0.0"
    experiment: "02-resources-fixed"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: worker-config-secure
  labels:
    app: worker
    version: "1.0.0"
data:
  WORKER_INTERVAL: "60"
  CLEANUP_DAYS: "30"
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: worker-service-pdb
  labels:
    app: worker
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: worker-service-secure
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker-service-secure
  labels:
    app: worker
    version: "1.0.0"
    component: background-worker
    experiment: "02-resources-fixed"
spec:
  # ✅ FIXED: Multiple replicas for high availability
  replicas: 2
  selector:
    matchLabels:
      app: worker-service-secure
      version: "1.0.0"
  # ✅ Proper deployment strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9091"
        prometheus.io/path: "/metrics"
      labels:
        app: worker-service-secure
        version: "1.0.0"
        component: background-worker
    spec:
      serviceAccountName: worker-service-secure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: worker
        image: "537651148488.dkr.ecr.us-east-1.amazonaws.com/cloud-native-app-dev-worker-service:latest"
        imagePullPolicy: IfNotPresent
        # ✅ FIXED: Resource requests and limits defined
        resources:
          requests:
            cpu: 100m              # ✅ Minimum CPU needed
            memory: 128Mi          # ✅ Minimum memory needed
          limits:
            cpu: 300m              # ✅ Maximum CPU allowed
            memory: 256Mi          # ✅ Maximum memory allowed
        # ✅ FIXED: Liveness probe (restart if unhealthy)
        livenessProbe:
          exec:
            command:
              - python
              - -c
              - "import psycopg2; print('alive')"
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        # ✅ FIXED: Readiness probe (traffic only when ready)
        readinessProbe:
          exec:
            command:
              - python
              - -c
              - "import sys; sys.exit(0)"
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        env:
          - name: DB_HOST
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: host
          - name: DB_PORT
            value: "5432"
          - name: DB_NAME
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: dbname
          - name: DB_USER
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: username
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: password
          - name: WORKER_INTERVAL
            valueFrom:
              configMapKeyRef:
                name: worker-config-secure
                key: WORKER_INTERVAL
          - name: CLEANUP_DAYS
            valueFrom:
              configMapKeyRef:
                name: worker-config-secure
                key: CLEANUP_DAYS
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1000
          readOnlyRootFilesystem: false
          capabilities:
            drop:
              - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}
      # ✅ FIXED: Pod anti-affinity for better distribution
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - worker-service-secure
              topologyKey: kubernetes.io/hostname
      # ✅ Tolerations for specific nodes (if needed)
      tolerations:
      - key: "workload-type"
        operator: "Equal"
        value: "background"
        effect: "NoSchedule"
---
# ✅ Horizontal Pod Autoscaler for automatic scaling
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: worker-service-hpa
  labels:
    app: worker
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: worker-service-secure
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max
