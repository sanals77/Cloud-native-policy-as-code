---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: worker-service-test
  labels:
    app: worker
    experiment: "02-missing-resources"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: worker-config-test
  labels:
    app: worker
    experiment: "02-missing-resources"
data:
  WORKER_INTERVAL: "60"
  CLEANUP_DAYS: "30"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker-service-test
  labels:
    app: worker
    version: "1.0.0"
    experiment: "02-missing-resources"
spec:
  # ⚠️ VIOLATION 1: Only 1 replica (no high availability)
  replicas: 1
  selector:
    matchLabels:
      app: worker-service-test
  # ⚠️ Missing: deployment strategy (defaults to RollingUpdate)
  template:
    metadata:
      labels:
        app: worker-service-test
        version: "1.0.0"
    spec:
      serviceAccountName: worker-service-test
      # Basic security (not a violation)
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
      - name: worker
        image: "537651148488.dkr.ecr.us-east-1.amazonaws.com/cloud-native-app-dev-worker-service:latest"
        imagePullPolicy: Always
        # ⚠️ VIOLATION 2: No resource requests defined
        # ⚠️ VIOLATION 3: No resource limits defined
        # ⚠️ VIOLATION 4: No liveness probe
        # ⚠️ VIOLATION 5: No readiness probe
        # resources: {}    # Commented out to show missing
        # livenessProbe: {}
        # readinessProbe: {}
        env:
          - name: DB_HOST
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: host
          - name: DB_PORT
            value: "5432"
          - name: DB_NAME
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: dbname
          - name: DB_USER
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: username
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: password
          - name: WORKER_INTERVAL
            valueFrom:
              configMapKeyRef:
                name: worker-config-test
                key: WORKER_INTERVAL
          - name: CLEANUP_DAYS
            valueFrom:
              configMapKeyRef:
                name: worker-config-test
                key: CLEANUP_DAYS
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
              - ALL
      # ⚠️ VIOLATION 6: No pod anti-affinity (poor distribution)
      # ⚠️ VIOLATION 7: No pod disruption budget
